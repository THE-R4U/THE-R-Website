---
title: Kaggle 예제
author: THE-R
date: '2018-04-15'
slug: kaggle
categories:
  - 캐글
tags:
  - 캐글
  - 시각화
  - 스포츠
description: ''
thumbnail: ''
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<center>
<img src="https://i.pinimg.com/originals/60/0a/f3/600af3325ac7608996d37a0869ec9c23.jpg">
</center>
<hr>
<p><strong>History :</strong></p>
<ul>
<li><em>version 1 : initial commit</em></li>
<li><em>version 2 : added World Cup history, fix some typos, some cosmetics</em></li>
<li><em>version 3 : added alluvials plots for the matches details</em></li>
<li><em>version 4 : added work for modeling section, added summary table</em></li>
<li><em>version 5 : fix logic, reshape code</em></li>
<li><em>version 6 : update code to find Cup winner, added tables for the 2002 to 2014 editions</em></li>
<li><em>version 7 : major cleanup and simplification to find the Cup Winner</em></li>
</ul>
<hr>
<pre class="r"><code>#load packages and csv file
library(ggplot2)
library(dplyr)
library(gridExtra)
library(RColorBrewer)
library(ggthemes)
library(viridis)
library(reshape2)
library(gridExtra)
library(scales)
library(ggalluvial)
library(knitr)
library(DT)
options(DT.options = list(pageLength = 4))</code></pre>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>There are 2 files in this dataset: 2개의 데이터셋이 있습니다.</p>
<ul>
<li>a summary showing all information about all the World Cups in the history.</li>
<li>details of matches showing all the results from the macthes.</li>
</ul>
<p>Plan for the kernel:</p>
<ul>
<li>overview</li>
<li>breakdown by edition and try to make some prediction for the <code>2018</code> edition.</li>
</ul>
<p><em>personal comment: for those who remember, PIQUE, the mascot of the 1986 edition, is still the best mascot ever</em></p>
</div>
<div id="data-preparation" class="section level1">
<h1>Data preparation</h1>
<ul>
<li>convert the <code>Attendance</code> column to numeric</li>
<li>make a <code>DateTime</code> variable</li>
</ul>
<pre class="r"><code>worldCups &lt;- read.csv(&#39;../../data/WorldCups.csv&#39;,sep=&#39;,&#39;,stringsAsFactors=F)
worldCups$Attendance &lt;- sapply(worldCups$Attendance, function(x) as.numeric(gsub(&quot;\\.&quot;,&quot;&quot;,x)))
worldCups$DateTS &lt;- as.Date(paste0(worldCups$Year,&#39;-01-01&#39;))
#head(worldCups)</code></pre>
<div id="making-colors-per-countries" class="section level2">
<h2>Making colors per countries</h2>
<p>The idea is to associate a unique color per country. That way we can visualizae both the winning countries and host countries in 1 plot.</p>
<p>Since the color hex code will be a column, I’m using <code>scale_fill_identity()</code>. However it also displays the legend as the <code>hex</code> codes, and not the name of Countries.</p>
<p>That’s why I made another plot(<code>myleg</code>) to represent the color code.</p>
<pre class="r"><code>countries &lt;-unique(sort(append(unique(worldCups$Winner),unique(worldCups$Country))))
cols&lt;-colorRampPalette(brewer.pal(9,&#39;Set1&#39;))(length(countries))
COLS &lt;- data.frame(color = cols, country = countries)
COLS$color &lt;- as.character(COLS$color)
COLS$country &lt;- as.character(COLS$country)
COLS$index &lt;- 1:nrow(COLS)</code></pre>
<pre class="r"><code># adding country host color
worldCups$CountryColor &lt;- sapply(worldCups$Country, function(x) COLS$color[match(x,COLS$country)])
# adding winner country color
worldCups$WinnerColor &lt;- sapply(worldCups$Winner, function(x) COLS$color[match(x,COLS$country)])</code></pre>
<pre class="r"><code># make a legend plot
myleg&lt;- COLS %&gt;% ggplot(aes(x=reorder(country,-index),y=1)) + 
  geom_bar(stat=&#39;identity&#39;,aes(fill=color)) + 
  coord_flip() + scale_fill_identity()+ 
  theme_fivethirtyeight() + 
  theme(panel.grid= element_blank() ,axis.text.x = element_blank())</code></pre>
<pre class="r"><code># add limits for the x-axis
lims &lt;- as.POSIXct(strptime(c(&quot;1927-01-01&quot;,&quot;2015-01-01&quot;), format = &quot;%Y-%m-%d&quot;))
# plotof goals vs year
g1 &lt;- worldCups %&gt;% ggplot(aes(x=as.POSIXct(DateTS),y=GoalsScored)) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1930-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1934-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1966-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1978-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1998-01-01&#39;)),alpha=.5) + 
  geom_line(alpha=.1,size=4) + 
  geom_point(aes(color=WinnerColor),size=4) + 
  theme_fivethirtyeight() + 
  scale_x_datetime(limits =lims, date_breaks=&quot;4 year&quot;, labels = date_format(&quot;%Y&quot;)) + 
  scale_color_identity()
# add the legend plot
g11 &lt;- g1 + annotation_custom( ggplotGrob(myleg), 
                               xmin=as.numeric(as.POSIXct(as.Date(&#39;1922-01-01&#39;))),
                               xmax=as.numeric(as.POSIXct(as.Date(&#39;1936-01-01&#39;))),
                               ymin=90,ymax=180) + 
  labs(title=&#39;Total Goals scored per World Cup&#39;)
# plot of Attendance vs year                    
g2 &lt;- worldCups %&gt;% ggplot(aes(x=as.POSIXct(DateTS),y=Attendance)) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1930-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1934-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1966-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1978-01-01&#39;)),alpha=.5) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1998-01-01&#39;)),alpha=.5) + 
  geom_line(alpha=.1,size=4) + 
  geom_point(aes(color=CountryColor),size=4) + 
  theme_fivethirtyeight() + 
  theme(axis.text.y =element_text(angle=75)) +
  scale_x_datetime(
    limits =lims, 
    date_breaks=&quot;4 year&quot;, 
    labels = date_format(&quot;%Y&quot;)) +
  scale_color_identity() + theme(axis.text.x=element_blank()) + labs(
    title=&#39;Attendance per World Cup&#39;,
    subtitle=&#39;vertical lines show editions for which the host country also won&#39;)</code></pre>
<pre class="r"><code># assemble everything
grid.arrange(g2,g11,ncol=1)</code></pre>
<p><img src="/post/2018-04-15-kaggle_files/figure-html/unnamed-chunk-7-1.png" width="1152" style="display: block; margin: auto;" /></p>
<ul>
<li><code>Uruguay(1930)</code>, <code>Italy(1934)</code>, <code>England(1966)</code> ,<code>Argentina(1978)</code> and <code>France(1998)</code> were the only editions where a host country also won the Cup.</li>
<li><code>1954</code>, <code>1982</code>, <code>1998</code> and <code>2014</code> will be interesting to investigate because of the spikes in the number of total goals scored.</li>
</ul>
</div>
</div>
<div id="history-of-the-world-cup" class="section level1">
<h1>History of the World Cup</h1>
<p>Via <a href="https://en.wikipedia.org/wiki/History_of_the_FIFA_World_Cup">Wikipedia</a></p>
<p>Very interesting to read since it reflects somehow events that happened worldwide. For example:</p>
<ul>
<li><code>1942</code>: The beginning of European hostilities in late 1939 prompted further plans for the 1942 World Cup to be cancelled, before a host country was selected. The FIFA tournament did not take place</li>
<li><code>1946</code>: end of WWII</li>
<li><code>1962</code>: Earthquake in Chile</li>
<li><code>1966</code>: England hosted the World Cup but South-Africa remained banned until 1992</li>
</ul>
<pre class="r"><code>matchesPlayed&lt;-worldCups %&gt;% ggplot(aes(x=as.POSIXct(DateTS),y= MatchesPlayed)) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1930-01-01&#39;)),size=1.5,alpha=1,color=&#39;red&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1934-01-01&#39;)),size=1.5,alpha=1,color=&#39;darkgreen&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1938-01-01&#39;)),size=1.5,alpha=1,color=&#39;darkgreen&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1950-01-01&#39;)),size=1.5,alpha=1,color=&#39;blue&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1954-01-01&#39;)),size=1.5,alpha=1,color=&#39;gold&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1970-01-01&#39;)),size=1.5,alpha=1,color=&#39;gold&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1974-01-01&#39;)),size=1.5,alpha=1,color=&#39;skyblue&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1978-01-01&#39;)),size=1.5,alpha=1,color=&#39;skyblue&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1982-01-01&#39;)),size=1.5,alpha=1,color=&#39;purple&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1986-01-01&#39;)),size=1.5,alpha=1,color=&#39;salmon&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1994-01-01&#39;)),size=1.5,alpha=1,color=&#39;salmon&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1998-01-01&#39;)),size=1.5,alpha=1,color=&#39;black&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;2014-01-01&#39;)),size=1.5,alpha=1,color=&#39;black&#39;) +
  geom_line(alpha=.2,size=3) + geom_point(size=3) + theme_fivethirtyeight() +
  scale_x_datetime(limits =lims, date_breaks=&quot;4 year&quot;, labels = date_format(&quot;%Y&quot;)) + 
  labs(title=&#39;Matches played&#39;,subtitle=&#39;Lines denote the changes in the format of each final tournament:\nhttps://en.wikipedia.org/wiki/History_of_the_FIFA_World_Cup&#39;) +
  theme(axis.text.x=element_blank())

qualifiedTeams&lt;-worldCups %&gt;% ggplot(aes(x=as.POSIXct(DateTS),y= QualifiedTeams)) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1930-01-01&#39;)),size=1.5,alpha=1,color=&#39;red&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1934-01-01&#39;)),size=1.5,alpha=1,color=&#39;darkgreen&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1938-01-01&#39;)),size=1.5,alpha=1,color=&#39;darkgreen&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1950-01-01&#39;)),size=1.5,alpha=1,color=&#39;blue&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1954-01-01&#39;)),size=1.5,alpha=1,color=&#39;gold&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1970-01-01&#39;)),size=1.5,alpha=1,color=&#39;gold&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1974-01-01&#39;)),size=1.5,alpha=1,color=&#39;skyblue&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1978-01-01&#39;)),size=1.5,alpha=1,color=&#39;skyblue&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1982-01-01&#39;)),size=1.5,alpha=1,color=&#39;purple&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1986-01-01&#39;)),size=1.5,alpha=1,color=&#39;salmon&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1994-01-01&#39;)),size=1.5,alpha=1,color=&#39;salmon&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1998-01-01&#39;)),size=1.5,alpha=1,color=&#39;black&#39;) +
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;2014-01-01&#39;)),size=1.5,alpha=1,color=&#39;black&#39;) +
  geom_line(alpha=.2,size=3) + geom_point(size=3) + 
  theme_fivethirtyeight() + 
  scale_x_datetime(limits =lims, date_breaks=&quot;4 year&quot;, labels = date_format(&quot;%Y&quot;)) + 
  scale_color_identity() + labs(title=&#39;Qualified teams&#39;) + 
  theme(axis.text.x=element_text(size=11))</code></pre>
<pre class="r"><code># assemble everything
grid.arrange(matchesPlayed, qualifiedTeams,ncol=1)</code></pre>
<p><img src="/post/2018-04-15-kaggle_files/figure-html/unnamed-chunk-9-1.png" width="1152" style="display: block; margin: auto;" /></p>
</div>
<div id="matches-details" class="section level1">
<h1>Matches details</h1>
<p>This dataset has the following features:</p>
<ul>
<li>Year</li>
<li>DateTime</li>
<li>Round</li>
<li>Stadium</li>
<li>City</li>
<li>HomeTeam</li>
<li>HomeGoals</li>
<li>AwayGoals</li>
<li>AwayTeam</li>
<li>Observation</li>
</ul>
<p>In this section I want to visualize the results of the finals round, so for simplicity I will gather the <code>Round</code> as <code>Round of 16</code>,<code>Quarter-finals</code>,<code>Semi-finals</code>,<code>Third Place</code>,<code>Final</code>.</p>
<p>I will also limit these results for World Cup after 1986. Before that time the finals rounds have a different structure.</p>
<p>First I will create a new column to determine the winner of each play; there are 2 cases to consider :</p>
<ul>
<li>the game ended at the 90mn with a winner / loser; here I can use the <code>HomeGoals</code> and <code>AwayGoals</code> to know which team won</li>
<li>the 90mn ened with a draw score, then the 2 teams went to the penalties goals. Here I use the <code>Observation</code> column to extract the result. An example looks like :</li>
</ul>
<pre class="r"><code>Argentina win on penalties (2 - 4)</code></pre>
<ul>
<li>the <code>regexp</code> extracts the 2 numbers inside the parenthesis, splits by <code>-</code>, and converts to numeric</li>
</ul>
<div id="codes" class="section level2">
<h2>Codes</h2>
<ul>
<li>load file and remove <code>NA's</code></li>
</ul>
<pre class="r"><code>df&lt;-read.csv(&#39;../../data/WorldCupMatches.csv&#39;,sep=&#39;,&#39;,stringsAsFactors=F)</code></pre>
<pre class="r"><code>na_count &lt;-data.frame(sapply(df, function(y) sum(length(which(is.na(y))))))
colnames(na_count)&lt;-&#39;number&#39;
names &lt;- rownames(na_count)
rownames(na_count) &lt;- NULL
na_count &lt;- cbind(names,na_count)
na_count$Percentage &lt;- (na_count$number / nrow(df)) * 100
na_count$Percent &lt;-paste0(round(na_count$Percentage,1),&quot;&quot;)
ggplot(data=na_count,aes(x=reorder(names,-number),y=number)) + 
  geom_histogram(stat=&#39;identity&#39;) + 
  theme(axis.text.x = element_text(angle=90, hjust=1)) + 
  ylab(&#39;Number of rows&#39;) + xlab(&#39;features&#39;) +
  geom_text(aes(label=Percent), position=position_dodge(width=0.9), hjust=0.25,vjust=-0.25,size=6,color=&#39;red&#39;)  +theme_fivethirtyeight() + labs(title=&#39;Missing values in dataset&#39;,subtitle=&#39;percentage in red&#39;)</code></pre>
<p><img src="/post/2018-04-15-kaggle_files/figure-html/unnamed-chunk-12-1.png" width="1152" style="display: block; margin: auto;" /></p>
<pre class="r"><code>df &lt;- df %&gt;% na.omit()
# clean up names
df$AwayTeam &lt;-ifelse(df$AwayTeam ==&#39;IR Iran&#39;,&#39;Iran&#39;,df$AwayTeam)
df$HomeTeam &lt;-ifelse(df$HomeTeam ==&#39;IR Iran&#39;,&#39;Iran&#39;,df$HomeTeam)</code></pre>
<ul>
<li>function to find the winner of each game</li>
</ul>
<pre class="r"><code>makeFinalScore&lt;-function(team1, team2, score1, score2, free1, free2){
    # decision made within time
    if(score1 != score2){
        if(score1 &gt; score2){
            return(team1)
        }
        else if(score2&gt;score1){
            return(team2)
        }
    }
    # decision made with free kicks
    else{
        if(free1 &gt; free2){
            return(team1)
            }
            else if(free2&gt;free1){
            return(team2)
        }
    }
}</code></pre>
<ul>
<li>loop over the full dataset, for year &gt; 1982</li>
</ul>
<pre class="r"><code>worldCup &lt;- list()
cnt &lt;- 0

for (edition in seq(1986,2014,4)){
    cnt &lt;- cnt + 1
    tempo &lt;- data.frame(df %&gt;% dplyr::filter(Year == edition &amp; (!grepl(&#39;Group&#39;,Round) &amp; !grepl(&#39;Play-off&#39;,Round))))
    tempo$Team_1_Score &lt;- sapply(tempo$Observation, function(x) as.numeric(trimws(strsplit(gsub(&quot;.*\\((.*)\\).*&quot;,&quot;\\1&quot;,x),&quot;-&quot;)[[1]])[1]))
    tempo$Team_2_Score &lt;- sapply(tempo$Observation, function(x) as.numeric(trimws(strsplit(gsub(&quot;.*\\((.*)\\).*&quot;,&quot;\\1&quot;,x),&quot;-&quot;)[[1]])[2]))
    tempo$gameWinner &lt;- mapply(makeFinalScore, tempo$HomeTeam,tempo$AwayTeam, tempo$HomeGoals, tempo$AwayGoals, tempo$Team_1_Score, tempo$Team_2_Score)
    worldCup[[cnt]] &lt;- tempo
}</code></pre>
<ul>
<li>for the visualization, I’m using <code>alluvial</code> plots(also known as <code>Parallel Coordinates Plot</code>) which are a nice way to represent how data flows accros features</li>
<li>I regroup all <code>Round</code> related to the <code>Third place</code> into a single one</li>
</ul>
<pre class="r"><code>makeSingleAlluvial &lt;- function(mydf, myyear){
    mydf$Round &lt;- ifelse(mydf$Round %in% c(&#39;Round of 16&#39;,&#39;Quarter-finals&#39;,&#39;Semi-finals&#39;,&#39;Final&#39;),mydf$Round, &quot;Third Place&quot;)
    gg&lt;-data.frame(mydf %&gt;% group_by(Round, gameWinner) %&gt;% summarise(count=n()))
    gg$Round &lt;- factor(gg$Round, levels=c(&#39;Round of 16&#39;,&#39;Quarter-finals&#39;,&#39;Semi-finals&#39;,&#39;Third Place&#39;,&#39;Final&#39;))
    
    ggplot(gg,aes(axis1 = gg[,2], axis2 = gg[,1])) + 
    geom_alluvium(aes(fill = factor(gg[,1])),width = 1/12,color=&#39;black&#39;,size=.25) +
    geom_stratum(width = 1/12, color = &quot;white&quot;,alpha=.1,size=.5) +
    geom_label(stat = &quot;stratum&quot;, 
               label.strata = TRUE,
               size=4.,
               color=&#39;white&#39;,
               fill=&#39;black&#39;) +
    scale_x_continuous(breaks = 1:2, 
                       labels = c(&#39;round&#39;, &#39;team&#39;)) + scale_fill_brewer(name=&#39;&#39;, palette=&#39;Set1&#39;) + theme_fivethirtyeight() + labs(title=paste0(&#39;Final rounds the &#39;,myyear,&#39; World Cup&#39;)) + theme(legend.position=&#39;bottom&#39;,legend.direction=&#39;horizontal&#39;,axis.text.y = element_blank(),axis.text.x = element_blank(),panel.grid = element_blank())
}</code></pre>
<ul>
<li>I then loop over the dataframes saved in the previous plots, and calls the function to make a single <code>alluvial</code> plot</li>
</ul>
<pre class="r"><code>alluvials &lt;- list()
years &lt;- seq(1986, 2014,4)
for(i in 1:length(years)){
    alluvials[[i]] &lt;- makeSingleAlluvial(worldCup[[i]],years[i])
}</code></pre>
</div>
<div id="alluvials-plots-for-world-cups-after-1982" class="section level2">
<h2><code>Alluvials plots</code> for World Cups after 1982</h2>
<pre class="r"><code>do.call(grid.arrange, c(alluvials, ncol=2))</code></pre>
<p><img src="/post/2018-04-15-kaggle_files/figure-html/unnamed-chunk-18-1.png" width="1152" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="prediction-modeling" class="section level1">
<h1>Prediction / modeling</h1>
<p>The idea is to look at the results of the preliminary phases only (ie before <code>Round of 16</code>) and find features to characterize the final outcome of the Cup. The reason is because some teams are already removed after these preliminary phases so there will no be predictive power.</p>
<p>I may also use the aggregated dataset to know whether the host country won or lost ; we can think of a team being <code>supported</code> at the national level as an important feature.</p>
<p>I cannot use the final number of wins or goals because these are <code>final</code> results hence are not related to the preliminary phases.</p>
<p>The features I’m thinking of:</p>
<ul>
<li>number of wins</li>
<li>number of draws</li>
<li>number of goals</li>
</ul>
<div id="tables-for-the-preliminary-rounds" class="section level2">
<h2>Tables for the <code>Preliminary Rounds</code></h2>
<p>Some work is needed to <code>flatten</code> the dataset since it has all the matches, ir each row is the result of as single match, whereas we want 1 row per Country.</p>
<div id="some-codes" class="section level3">
<h3>Some codes</h3>
<pre class="r"><code># function to determine the winner/loser of each match
makeFinalScoreRound&lt;-function(team1, team2, score1, score2){
        if(score1 &gt; score2){
            return(team1)
        }
        else if(score2&gt;score1){
            return(team2)
        }
        else {return(&#39;Draw&#39;)
    }
}</code></pre>
<pre class="r"><code># function to calculate the number of points of each game
makePointsRound&lt;-function(team1, team2, score1, score2){
            #win
        if(score1 &gt; score2){
            return(3)
        }
        #loose
        else if(score2&gt;score1){
            return(0)
        }
        #draw
        else {return(1)
    }
}</code></pre>
<ul>
<li>main code / function</li>
</ul>
<pre class="r"><code>makeGroupSummary &lt;- function(myyear){
  
  df2 &lt;- df %&gt;% filter(Year==myyear)
  groups &lt;- data.frame(df2 %&gt;% filter(grepl(&#39;Group&#39;,Round)))
  groups$gameWinner &lt;- mapply(makeFinalScoreRound, groups$HomeTeam,groups$AwayTeam, groups$HomeGoals, groups$AwayGoals)
  groups$Team_1_Score &lt;- mapply(makePointsRound, groups$HomeTeam,groups$AwayTeam, groups$HomeGoals, groups$AwayGoals)
  groups$Team_2_Score &lt;- mapply(makePointsRound, groups$AwayTeam,groups$HomeTeam, groups$AwayGoals, groups$HomeGoals)
  
  groupList &lt;- list()
  cnt&lt;-0
  for(mygroup in unique(groups$Round)){
    cnt&lt;-cnt+1
    dat0 &lt;- data.frame(groups %&gt;% filter(Round == mygroup))
    dat1 &lt;- data.frame(rbind(
      dat0 %&gt;% group_by(HomeTeam) %&gt;% summarise(count = n(), points = sum(Team_1_Score), goals= sum(HomeGoals)) %&gt;% rename(team = HomeTeam),
      dat0 %&gt;% group_by(AwayTeam) %&gt;% summarise(count=n(), points = sum(Team_2_Score), goals = sum(AwayGoals)) %&gt;% rename(team = AwayTeam)))
    dat2 &lt;- data.frame(dat1 %&gt;% group_by(team) %&gt;% summarise(totGames = sum(count), totPoints = sum(points), totGoals = sum(goals)) %&gt;% arrange(-totPoints,-totGoals))
    dat2$rank&lt;-c(1:4)
    dat2$Group &lt;- rep(mygroup,4)
    groupList[[cnt]] &lt;- dat2
    }
  
  RES&lt;-data.frame(do.call(&quot;rbind&quot;,groupList))
  
  # find the winner with the previous dataset
  winner &lt;-(worldCups %&gt;% filter(Year==myyear) %&gt;% select(Winner))$Winner
 
  RES$hasWon&lt;-ifelse(RES$team == winner,&#39;WON&#39;,&#39;LOST&#39;)
  
  return(RES)
}</code></pre>
</div>
<div id="results-for-the-1998-edition" class="section level3">
<h3>Results for the <code>1998</code> edition</h3>
<ul>
<li>France (<code>group C</code>, 4th tab) won.</li>
</ul>
<pre class="r"><code>edition_1998 &lt;- makeGroupSummary(1998)</code></pre>
<pre class="r"><code>options(DT.options = list(pageLength = 4))
datatable(edition_1998) %&gt;% 
  formatStyle(
  &#39;rank&#39;,
  target = &#39;row&#39;,
  backgroundColor = styleEqual(c(1, 2, 3, 4), c(&#39;greenyellow&#39;,&#39;greenyellow&#39;,&#39;gray40&#39;, &#39;gray80&#39;))
)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Brazil","Norway","Morocco","Scotland","Italy","Chile","Austria","Cameroon","Nigeria","Paraguay","Spain","Bulgaria","France","Denmark","South Africa","Saudi Arabia","Mexico","Netherlands","Belgium","Korea Republic","Argentina","Croatia","Jamaica","Japan","Germany","Yugoslavia","Iran","USA","Romania","England","Colombia","Tunisia"],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[6,5,4,1,7,3,2,2,6,5,4,1,9,4,2,1,5,5,3,1,9,6,3,0,7,7,3,0,7,6,3,1],[6,5,5,2,7,4,3,2,5,3,8,1,9,3,3,2,7,7,3,2,7,4,3,1,6,4,2,1,4,5,1,1],[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],["Group A","Group A","Group A","Group A","Group B","Group B","Group B","Group B","Group D","Group D","Group D","Group D","Group C","Group C","Group C","Group C","Group E","Group E","Group E","Group E","Group H","Group H","Group H","Group H","Group F","Group F","Group F","Group F","Group G","Group G","Group G","Group G"],["LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","WON","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>team<\/th>\n      <th>totGames<\/th>\n      <th>totPoints<\/th>\n      <th>totGoals<\/th>\n      <th>rank<\/th>\n      <th>Group<\/th>\n      <th>hasWon<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":4,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[4,10,25,50,100],"rowCallback":"function(row, data) {\nvar value=data[5]; $(row).css({'background-color':value == '1' ? 'greenyellow' : value == '2' ? 'greenyellow' : value == '3' ? 'gray40' : value == '4' ? 'gray80' : ''});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
<div id="results-for-the-2002-edition" class="section level3">
<h3>Results for the <code>2002</code> edition</h3>
<ul>
<li>Brazil (<code>group C</code>, 5th tab) won.</li>
</ul>
<pre class="r"><code>edition_2002 &lt;- makeGroupSummary(2002)</code></pre>
<pre class="r"><code>options(DT.options = list(pageLength = 4))
datatable(edition_2002) %&gt;% 
  formatStyle(
  &#39;rank&#39;,
  target = &#39;row&#39;,
  backgroundColor = styleEqual(c(1, 2, 3, 4), c(&#39;greenyellow&#39;,&#39;greenyellow&#39;,&#39;gray40&#39;, &#39;gray80&#39;))
)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Denmark","Senegal","Uruguay","France","Germany","Republic of Ireland","Cameroon","Saudi Arabia","Sweden","England","Argentina","Nigeria","Spain","Paraguay","South Africa","Slovenia","Brazil","Costa Rica","Turkey","China PR","Mexico","Italy","Croatia","Ecuador","Japan","Belgium","Russia","Tunisia","Korea Republic","USA","Portugal","Poland"],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[7,5,2,1,7,5,4,0,5,5,4,1,9,4,4,0,9,4,4,0,7,4,3,3,7,5,3,1,7,4,3,3],[5,5,4,0,11,5,2,0,4,2,2,1,9,6,5,2,11,5,5,0,4,4,2,2,5,6,4,1,4,5,6,3],[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],["Group A","Group A","Group A","Group A","Group E","Group E","Group E","Group E","Group F","Group F","Group F","Group F","Group B","Group B","Group B","Group B","Group C","Group C","Group C","Group C","Group G","Group G","Group G","Group G","Group H","Group H","Group H","Group H","Group D","Group D","Group D","Group D"],["LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","WON","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>team<\/th>\n      <th>totGames<\/th>\n      <th>totPoints<\/th>\n      <th>totGoals<\/th>\n      <th>rank<\/th>\n      <th>Group<\/th>\n      <th>hasWon<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":4,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[4,10,25,50,100],"rowCallback":"function(row, data) {\nvar value=data[5]; $(row).css({'background-color':value == '1' ? 'greenyellow' : value == '2' ? 'greenyellow' : value == '3' ? 'gray40' : value == '4' ? 'gray80' : ''});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
<div id="results-for-the-2006-edition" class="section level3">
<h3>Results for the <code>2006</code> edition</h3>
<ul>
<li>Italy (<code>group E</code>, 6th tab) won.</li>
</ul>
<pre class="r"><code>edition_2006 &lt;- makeGroupSummary(2002)</code></pre>
<pre class="r"><code>options(DT.options = list(pageLength = 4))
datatable(edition_2006) %&gt;% 
  formatStyle(
  &#39;rank&#39;,
  target = &#39;row&#39;,
  backgroundColor = styleEqual(c(1, 2, 3, 4), c(&#39;greenyellow&#39;,&#39;greenyellow&#39;,&#39;gray40&#39;, &#39;gray80&#39;))
)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Denmark","Senegal","Uruguay","France","Germany","Republic of Ireland","Cameroon","Saudi Arabia","Sweden","England","Argentina","Nigeria","Spain","Paraguay","South Africa","Slovenia","Brazil","Costa Rica","Turkey","China PR","Mexico","Italy","Croatia","Ecuador","Japan","Belgium","Russia","Tunisia","Korea Republic","USA","Portugal","Poland"],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[7,5,2,1,7,5,4,0,5,5,4,1,9,4,4,0,9,4,4,0,7,4,3,3,7,5,3,1,7,4,3,3],[5,5,4,0,11,5,2,0,4,2,2,1,9,6,5,2,11,5,5,0,4,4,2,2,5,6,4,1,4,5,6,3],[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],["Group A","Group A","Group A","Group A","Group E","Group E","Group E","Group E","Group F","Group F","Group F","Group F","Group B","Group B","Group B","Group B","Group C","Group C","Group C","Group C","Group G","Group G","Group G","Group G","Group H","Group H","Group H","Group H","Group D","Group D","Group D","Group D"],["LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","WON","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>team<\/th>\n      <th>totGames<\/th>\n      <th>totPoints<\/th>\n      <th>totGoals<\/th>\n      <th>rank<\/th>\n      <th>Group<\/th>\n      <th>hasWon<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":4,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[4,10,25,50,100],"rowCallback":"function(row, data) {\nvar value=data[5]; $(row).css({'background-color':value == '1' ? 'greenyellow' : value == '2' ? 'greenyellow' : value == '3' ? 'gray40' : value == '4' ? 'gray80' : ''});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
<div id="results-for-the-2010-edition" class="section level3">
<h3>Results for the <code>2010</code> edition</h3>
<ul>
<li>Spain (<code>group H</code>, 8th tab) won.</li>
</ul>
<pre class="r"><code>edition_2010 &lt;- makeGroupSummary(2010)</code></pre>
<pre class="r"><code>options(DT.options = list(pageLength = 4))
datatable(edition_2010) %&gt;% 
  formatStyle(
  &#39;rank&#39;,
  target = &#39;row&#39;,
  backgroundColor = styleEqual(c(1, 2, 3, 4), c(&#39;greenyellow&#39;,&#39;greenyellow&#39;,&#39;gray40&#39;, &#39;gray80&#39;))
)</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Uruguay","Mexico","South Africa","France","Argentina","Korea Republic","Greece","Nigeria","USA","England","Slovenia","Algeria","Germany","Australia","Ghana","Serbia","Netherlands","Japan","Denmark","Cameroon","Paraguay","Slovakia","New Zealand","Italy","Brazil","Portugal","C<ef><bf><bd>te d'Ivoire","Korea DPR","Spain","Chile","Switzerland","Honduras"],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[7,4,4,1,9,4,3,1,5,5,4,1,6,4,4,3,9,6,3,0,5,4,3,2,7,5,4,0,6,6,4,1],[4,3,3,1,7,5,2,3,4,2,3,0,5,3,2,2,5,4,3,2,3,4,2,4,5,7,4,1,4,3,1,0],[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],["Group A","Group A","Group A","Group A","Group B","Group B","Group B","Group B","Group C","Group C","Group C","Group C","Group D","Group D","Group D","Group D","Group E","Group E","Group E","Group E","Group F","Group F","Group F","Group F","Group G","Group G","Group G","Group G","Group H","Group H","Group H","Group H"],["LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","WON","LOST","LOST","LOST"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>team<\/th>\n      <th>totGames<\/th>\n      <th>totPoints<\/th>\n      <th>totGoals<\/th>\n      <th>rank<\/th>\n      <th>Group<\/th>\n      <th>hasWon<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":4,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[4,10,25,50,100],"rowCallback":"function(row, data) {\nvar value=data[5]; $(row).css({'background-color':value == '1' ? 'greenyellow' : value == '2' ? 'greenyellow' : value == '3' ? 'gray40' : value == '4' ? 'gray80' : ''});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
<div id="results-for-the-2014-edition" class="section level3">
<h3>Results for the <code>2014</code> edition</h3>
<ul>
<li>Germany (<code>group G</code>, 7th tab) won.</li>
</ul>
<pre class="r"><code>edition_2014 &lt;- makeGroupSummary(2014)</code></pre>
<pre class="r"><code>options(DT.options = list(pageLength = 4))
datatable(edition_2014) %&gt;% 
  formatStyle(
  &#39;rank&#39;,
  target = &#39;row&#39;,
  backgroundColor = styleEqual(c(1, 2, 3, 4), c(&#39;greenyellow&#39;,&#39;greenyellow&#39;,&#39;gray40&#39;, &#39;gray80&#39;))
)</code></pre>
<div id="htmlwidget-5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Brazil","Mexico","Croatia","Cameroon","Netherlands","Chile","Spain","Australia","Colombia","Greece","C<ef><bf><bd>te d'Ivoire","Japan","Costa Rica","Uruguay","Italy","England","France","Switzerland","Ecuador","Honduras","Argentina","Nigeria","Bosnia and Herzegovina","Iran","Germany","Portugal","USA","Ghana","Belgium","Algeria","Russia","Korea Republic"],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[7,7,3,0,9,6,3,0,9,4,3,1,7,6,3,1,7,6,4,0,9,4,3,1,7,4,4,1,9,4,2,1],[7,4,6,1,10,5,4,3,9,2,4,2,4,4,2,2,8,7,3,1,6,3,4,1,7,4,4,4,4,6,2,3],[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],["Group A","Group A","Group A","Group A","Group B","Group B","Group B","Group B","Group C","Group C","Group C","Group C","Group D","Group D","Group D","Group D","Group E","Group E","Group E","Group E","Group F","Group F","Group F","Group F","Group G","Group G","Group G","Group G","Group H","Group H","Group H","Group H"],["LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","LOST","WON","LOST","LOST","LOST","LOST","LOST","LOST","LOST"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>team<\/th>\n      <th>totGames<\/th>\n      <th>totPoints<\/th>\n      <th>totGoals<\/th>\n      <th>rank<\/th>\n      <th>Group<\/th>\n      <th>hasWon<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":4,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[4,10,25,50,100],"rowCallback":"function(row, data) {\nvar value=data[5]; $(row).css({'background-color':value == '1' ? 'greenyellow' : value == '2' ? 'greenyellow' : value == '3' ? 'gray40' : value == '4' ? 'gray80' : ''});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
</div>
<div id="generalizing-to-the-other-editions" class="section level2">
<h2>Generalizing to the other editions</h2>
<pre class="r"><code>df$DateTS &lt;- as.Date(paste0(df$Year,&#39;-01-01&#39;))
df %&gt;% filter(grepl(&#39;Group&#39;,Round)) %&gt;% group_by(DateTS, Round) %&gt;% summarise(count=n()) %&gt;%
  ggplot(aes(x=as.POSIXct(DateTS),y=count,fill=Round)) + 
  geom_bar(stat=&#39;identity&#39;,color=&#39;black&#39;,size=.5) + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12,&#39;Paired&#39;))(14)) + 
  theme_fivethirtyeight(14) + 
  labs(title=&#39;Preliminary groups structure&#39;,subtitle=&#39;represented are the number of teams in each group&#39;)+ 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1972-01-01&#39;)),color=&#39;red&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1980-01-01&#39;)),color=&#39;red&#39;) + 
  geom_vline(xintercept= as.POSIXct(as.Date(&#39;1984-01-01&#39;)),color=&#39;red&#39;)</code></pre>
<p><img src="/post/2018-04-15-kaggle_files/figure-html/unnamed-chunk-32-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>The issues with the preliminary groups over time are :</p>
<ul>
<li>different number of groups</li>
<li>different notations: between 1970 and 1982, they were labelled with number and letter</li>
<li>after 1992, the number of preliminary groups is the same(only letters) so I can start with that period</li>
</ul>
</div>
</div>
